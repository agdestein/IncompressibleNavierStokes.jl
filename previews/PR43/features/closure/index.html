<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Neural closure models · IncompressibleNavierStokes.jl</title><meta name="title" content="Neural closure models · IncompressibleNavierStokes.jl"/><meta property="og:title" content="Neural closure models · IncompressibleNavierStokes.jl"/><meta property="twitter:title" content="Neural closure models · IncompressibleNavierStokes.jl"/><meta name="description" content="Documentation for IncompressibleNavierStokes.jl."/><meta property="og:description" content="Documentation for IncompressibleNavierStokes.jl."/><meta property="twitter:description" content="Documentation for IncompressibleNavierStokes.jl."/><meta property="og:url" content="https://agdestein.github.io/IncompressibleNavierStokes.jl/features/closure/"/><meta property="twitter:url" content="https://agdestein.github.io/IncompressibleNavierStokes.jl/features/closure/"/><link rel="canonical" href="https://agdestein.github.io/IncompressibleNavierStokes.jl/features/closure/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="IncompressibleNavierStokes.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">IncompressibleNavierStokes.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../getting_started/">Getting Started</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../../generated/LidDrivenCavity2D/">Tutorial: Lid-Driven Cavity (2D)</a></li></ul></li><li><span class="tocitem">Equations</span><ul><li><a class="tocitem" href="../../equations/ns/">Incompressible Navier-Stokes equations</a></li><li><a class="tocitem" href="../../equations/spatial/">Spatial discretization</a></li><li><a class="tocitem" href="../../equations/time/">Time discretization</a></li></ul></li><li><span class="tocitem">Features</span><ul><li><a class="tocitem" href="../bc/">Boundary conditions</a></li><li><a class="tocitem" href="../pressure/">Pressure solvers</a></li><li><a class="tocitem" href="../precision/">Floating point precision</a></li><li><a class="tocitem" href="../gpu/">GPU Support</a></li><li><a class="tocitem" href="../operators/">Operators</a></li><li><a class="tocitem" href="../les/">Large eddy simulation</a></li><li class="is-active"><a class="tocitem" href>Neural closure models</a><ul class="internal"><li><a class="tocitem" href="#Training"><span>Training</span></a></li><li><a class="tocitem" href="#Neural-architectures"><span>Neural architectures</span></a></li></ul></li></ul></li><li><span class="tocitem">API Reference</span><ul><li><a class="tocitem" href="../../api/api/">API</a></li><li><a class="tocitem" href="../../api/tableaux/">Runge-Kutta methods</a></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Features</a></li><li class="is-active"><a href>Neural closure models</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Neural closure models</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/agdestein/IncompressibleNavierStokes.jl/blob/main/docs/src/features/closure.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Neural-closure-models"><a class="docs-heading-anchor" href="#Neural-closure-models">Neural closure models</a><a id="Neural-closure-models-1"></a><a class="docs-heading-anchor-permalink" href="#Neural-closure-models" title="Permalink"></a></h1><p>For <a href="../les/">large eddy simulation (LES)</a>, a closure model is required. With IncompressibleNavierStokes, a neural closure model can be trained on filtered DNS data. The discrete DNS equations are given by</p><p class="math-container">\[\begin{split}
M u &amp; = 0, \\
\frac{\mathrm{d} u}{\mathrm{d} t} &amp; = F(u) - G p.
\end{split}\]</p><p>Applying a spatial filter <span>$\Phi$</span>, the extracted large scale components <span>$\bar{u} = \Phi u$</span> are governed by the equation</p><p class="math-container">\[\begin{split}
M \bar{u} &amp; = 0, \\
\frac{\mathrm{d} \bar{u}}{\mathrm{d} t} &amp; = F(\bar{u}) + c - G \bar{p},
\end{split}\]</p><p>where the discretizations <span>$M$</span>, <span>$F$</span>, and <span>$G$</span> are adapted to the size of their inputs and <span>$c = \overline{F(u)} - F(\bar{u})$</span> is a commutator error. We here assumed that <span>$M$</span> and <span>$\Phi$</span> commute, which is the case for face averaging filters. Replacing <span>$c$</span> with a parameterized closure model <span>$m(\bar{u}, \theta) \approx c$</span> gives the LES equations for the approximate large scale velocity <span>$\bar{v} \approx \bar{u}$</span></p><p class="math-container">\[\begin{split}
M \bar{v} &amp; = 0, \\
\frac{\mathrm{d} \bar{v}}{\mathrm{d} t} &amp; = F(\bar{v}) + m(\bar{v}, \theta) - G \bar{q}.
\end{split}\]</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IncompressibleNavierStokes.face_average!" href="#IncompressibleNavierStokes.face_average!"><code>IncompressibleNavierStokes.face_average!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">face_average!(v, u, setup, comp)</code></pre><p>Average <code>u</code> over volume faces. Put result in <code>v</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/agdestein/IncompressibleNavierStokes.jl/blob/44d05f775a089d6e8c4103a25b82249e1daf6917/src/filter.jl#L1-L5">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IncompressibleNavierStokes.create_les_data" href="#IncompressibleNavierStokes.create_les_data"><code>IncompressibleNavierStokes.create_les_data</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">create_les_data(
    T;
    D = 2,
    Re = T(2_000),
    lims = (T(0), T(1)),
    nles = 64,
    compression = 4,
    nsim = 10,
    tburn = T(0.1),
    tsim = T(0.1),
    Δt = T(1e-4),
    ArrayType = Array,
)</code></pre><p>Create filtered DNS data.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/agdestein/IncompressibleNavierStokes.jl/blob/44d05f775a089d6e8c4103a25b82249e1daf6917/src/closures/create_les_data.jl#L83-L100">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IncompressibleNavierStokes.create_io_arrays" href="#IncompressibleNavierStokes.create_io_arrays"><code>IncompressibleNavierStokes.create_io_arrays</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">create_io_arrays(data, setup)</code></pre><p>Create <span>$(\bar{u}, c)$</span> pairs for training.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/agdestein/IncompressibleNavierStokes.jl/blob/44d05f775a089d6e8c4103a25b82249e1daf6917/src/closures/create_les_data.jl#L197-L201">source</a></section></article><h2 id="Training"><a class="docs-heading-anchor" href="#Training">Training</a><a id="Training-1"></a><a class="docs-heading-anchor-permalink" href="#Training" title="Permalink"></a></h2><p>To improve the model parameters, we exploit exact filtered DNS data <span>$\bar{u}$</span> and exact commutator errors <span>$c$</span> obtained through DNS. The model is trained by minimizing the a priori loss function</p><p class="math-container">\[L^\text{prior}(\theta) = \| m(\bar{u}, \theta) - c \|^2,\]</p><p>or the a posteriori loss function</p><p class="math-container">\[L^\text{post}(\theta) = \| \bar{v}_\theta - \bar{u} \|^2,\]</p><p>where <span>$\bar{v}_\theta$</span> is the solution to the LES equation for the given parameters <span>$\theta$</span>. The prior loss is easy to evaluate and easy to differentiate, as it does not involve solving the ODE. However, minimizing <span>$L^\text{prior}$</span> does not take into account the effect of the prediction error on the LES solution error. The posterior loss does, but has a longer computational chain involving solving the LES ODE.</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IncompressibleNavierStokes.train" href="#IncompressibleNavierStokes.train"><code>IncompressibleNavierStokes.train</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">train(
    loss,
    opt,
    θ;
    niter = 100,
    ncallback = 1,
    callback = (i, θ) -&gt; println(&quot;Iteration $i of $niter&quot;),
)</code></pre><p>Update parameters <code>θ</code> to minimize <code>loss(θ)</code> using the optimiser <code>opt</code> for <code>niter</code> iterations.</p><p>Return the a new named tuple <code>(; opt, θ, callbackstate)</code> with updated state and parameters.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/agdestein/IncompressibleNavierStokes.jl/blob/44d05f775a089d6e8c4103a25b82249e1daf6917/src/closures/training.jl#L1-L16">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IncompressibleNavierStokes.create_randloss" href="#IncompressibleNavierStokes.create_randloss"><code>IncompressibleNavierStokes.create_randloss</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">create_randloss(loss, f, x, y; nuse = size(x, 2), device = identity)</code></pre><p>Create loss function <code>randloss(θ)</code> that uses a batch of <code>nuse</code> random samples from <code>(x, y)</code> at each evaluation.</p><p>The function <code>loss</code> should take inputs like <code>loss(f, x, y, θ)</code>.</p><p>The batch is moved to <code>device</code> before the loss is evaluated.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/agdestein/IncompressibleNavierStokes.jl/blob/44d05f775a089d6e8c4103a25b82249e1daf6917/src/closures/training.jl#L36-L45">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IncompressibleNavierStokes.mean_squared_error" href="#IncompressibleNavierStokes.mean_squared_error"><code>IncompressibleNavierStokes.mean_squared_error</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">mean_squared_error(f, x, y, θ; normalize = y -&gt; sum(abs2, y), λ = sqrt(eps(eltype(x))))</code></pre><p>Compute MSE between <code>f(x, θ)</code> and <code>y</code>.</p><p>The MSE is further divided by <code>normalize(y)</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/agdestein/IncompressibleNavierStokes.jl/blob/44d05f775a089d6e8c4103a25b82249e1daf6917/src/closures/training.jl#L57-L63">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IncompressibleNavierStokes.relative_error" href="#IncompressibleNavierStokes.relative_error"><code>IncompressibleNavierStokes.relative_error</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">relative_error(x, y)</code></pre><p>Compute average column relative error between matrices <code>x</code> and <code>y</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/agdestein/IncompressibleNavierStokes.jl/blob/44d05f775a089d6e8c4103a25b82249e1daf6917/src/closures/training.jl#L67-L71">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IncompressibleNavierStokes.create_callback" href="#IncompressibleNavierStokes.create_callback"><code>IncompressibleNavierStokes.create_callback</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">create_callback(
    f,
    x,
    y;
    state = Point2f[],
    display_each_iteration = false,
)</code></pre><p>Create convergence plot for relative error between <code>f(x, θ)</code> and <code>y</code>. At each callback, plot is updated and current error is printed.</p><p>If <code>state</code> is nonempty, it also plots previous convergence.</p><p>If not using interactive GLMakie window, set <code>display_each_iteration</code> to <code>true</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/agdestein/IncompressibleNavierStokes.jl/blob/44d05f775a089d6e8c4103a25b82249e1daf6917/src/closures/training.jl#L75-L91">source</a></section></article><h2 id="Neural-architectures"><a class="docs-heading-anchor" href="#Neural-architectures">Neural architectures</a><a id="Neural-architectures-1"></a><a class="docs-heading-anchor-permalink" href="#Neural-architectures" title="Permalink"></a></h2><p>We provide two neural architectures: A convolutional neural network (CNN) and a Fourier neural operator (FNO).</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IncompressibleNavierStokes.cnn" href="#IncompressibleNavierStokes.cnn"><code>IncompressibleNavierStokes.cnn</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">cnn(setup, r, c, σ, b; kwargs...)</code></pre><p>Create CNN closure model. Return a tuple <code>(closure, θ)</code> where <code>θ</code> are the initial parameters and <code>closure(u, θ)</code> predicts the commutator error.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/agdestein/IncompressibleNavierStokes.jl/blob/44d05f775a089d6e8c4103a25b82249e1daf6917/src/closures/cnn.jl#L1-L6">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IncompressibleNavierStokes.fno" href="#IncompressibleNavierStokes.fno"><code>IncompressibleNavierStokes.fno</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">fno(setup, kmax, c, σ, ψ; rng = Random.default_rng(), kwargs...)</code></pre><p>Create FNO closure model. Return a tuple <code>(closure, θ)</code> where <code>θ</code> are the initial parameters and <code>closure(V, θ)</code> predicts the commutator error.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/agdestein/IncompressibleNavierStokes.jl/blob/44d05f775a089d6e8c4103a25b82249e1daf6917/src/closures/fno.jl#L1-L6">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IncompressibleNavierStokes.FourierLayer" href="#IncompressibleNavierStokes.FourierLayer"><code>IncompressibleNavierStokes.FourierLayer</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">FourierLayer(dimension, kmax, cin =&gt; cout; σ = identity, init_weight = glorot_uniform)</code></pre><p>Fourier layer operating on uniformly discretized functions.</p><p>Some important sizes:</p><ul><li><code>dimension</code>: Spatial dimension, e.g. <code>Dimension(2)</code> or <code>Dimension(3)</code>.</li><li><code>(nx..., cin, nsample)</code>: Input size</li><li><code>(nx..., cout, nsample)</code>: Output size</li><li><code>nx = fill(n, dimension())</code>: Number of points in each spatial dimension</li><li><code>n ≥ kmax</code>: Same number of points in each spatial dimension, must be larger than cut-off wavenumber</li><li><code>kmax</code>: Cut-off wavenumber</li><li><code>nsample</code>: Number of input samples (treated independently)</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/agdestein/IncompressibleNavierStokes.jl/blob/44d05f775a089d6e8c4103a25b82249e1daf6917/src/closures/fno.jl#L54-L69">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../les/">« Large eddy simulation</a><a class="docs-footer-nextpage" href="../../api/api/">API »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.1.2 on <span class="colophon-date" title="Sunday 12 November 2023 12:30">Sunday 12 November 2023</span>. Using Julia version 1.9.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
